# gis框架系列

## 简介

&emsp;前端以 gis 框架为中心的相关项目。

&emsp;主要可以分成以下两部分:

1. 小组内自研的 gis 框架，以 three.js 为基础实现。
2. gis 框架衍生的项目

## 衍生项目

&emsp;先说衍生的项目，因为一开始小组内原本就有能用的 gis 框架，一开始的项目都是以现有的 gis 框架为基础进行开发的，我只是进行调用，在项目中使用，对其原理并不懂。到了后来进行了重新开发，才开始了解内部的运行机制。

&emsp;我涉及的相关项目以下两个: 

1. 打标工具
2. 高精地图重建

### 打标工具

&emsp;内部使用的工具，通过照片和模型对应，得到相机视角的参数。以 vue 为基础实现，主要是在二维图片和三维模型上点击标注对应的点， 然后将数据传到后台， 返回得到相机各个参数。

&emsp;首先是先输入参数的页面，包括 3dTiles 模型的线上地址、模型的中心点位、模型的类型、各个相机的经纬度信息、 相机对应的照片。

&emsp;进入打标页面，主要是分左右两个部分，一个是左边的图片， canvas 2d 绘制，另一个是右边的三维模型 gis 框架， 然后找到图片和模型能够对应的地方，鼠标两边点击打点，图片上绘制点， 三维模型上则添加点模型。

&emsp;当打的点位足够多的时候，调用后台借口上传参数，后台计算出对应的相机畸变参数返回给前端，前端记录保存下来，将信息导出。

### 高精地图重建

&emsp;与之江实验室的合作项目。以 vue 为基础实现，有点类似前端的智慧城市项目，不过主要就是为了实验室内部进行测试和展示的。主要是 html 页面和 webgl 三维两部份组成。

&emsp;html 页面，单纯的展示了一下相关数据，需要注意的就是一些图片数据需要经过第三方接口的验证。

&emsp;webgl 三维，就是 gis 展示地图和 3dTiles 模型，然后开始接收 websocket 数据，可以展示相机下的人员模型以及用热力图的方式展示人员密集度，还可以展示车辆，车辆为数据采集车，根据数据采集车采集到数据，以一个立方体表示采集车捕获到的障碍物，并且点击显示对应的障碍物图片。

&emsp;显示车辆的时候采用了防抖机制，即过几秒钟如果没有对应的数据传过来的话，就会自动消失，有的话就一直显示，推迟消失。

&emsp;值得一提的是，我在更新模型的时候，整了个操作，直接对模型内的几何体的顶点属性进行修改，不是销毁后新建。视觉上没什么问题，只是后来与鼠标交互点击的时候，没有捕获到模型，出问题了。发现问题之后，当时因为时间关系，直接改成了销毁后新建，解决问题了。后来的话，又研究了一下，在直接更新几何体的顶点属性之后，需要再重新计算一下包围球，这样其实更方便。

## gis 框架

&emsp;基于 three.js 实现的地理信息系统框架。之前的项目使用的都是小组内原本就有一个 gis 框架的，不过之前开发维护的人跑路了，然后小组内就没人懂了，之前的框架就只能用，不能改了(对于大厂的滤镜开始破碎)。然后我就主动和我主管沟通了一下，重新开发了相关的框架。~~抄袭~~参考了小组内原本的 gis 框架，以及很多 github 上的开源框架，同时也学到了不少 gis 相关的知识，以及一些模型解析的规范等等。

&emsp;~~抄袭~~参考和打算~~抄袭~~参考的的开源框架如下: [WebGlobe](https://github.com/iSpring/WebGlobe)、[itowns](https://github.com/iTowns/itowns)、[cesium](https://github.com/CesiumGS/cesium)、[geo-three](https://github.com/tentone/geo-three)、[3DTilesRendererJS](https://github.com/NASA-AMMOS/3DTilesRendererJS)

&emsp;在重新开发的时候，我个人的计划是分为四个步骤的: 

1. 首先是要实现将地球作为一个单独的模型添加到 three 的场景中。需要做的是，根据每个瓦片的序列生产对应的模型，然后根据相机当前的视角计算得出需要展示的瓦片，然后添加控制器操作相机视角的变化，最后实现瓦片由于相机视角不断变化中而进行的更新。

2. 添加其他的三维展示功能，比如说倾斜摄影、图标、模型动画等等。其中主要要实现的还是倾斜摄影。

3. 使用重新开发好的 gis 框架对部分使用之前 gis 框架的项目进行开发替代，也算是一种检测。

4. 书写框架文档，包括使用代码的接口文档，相关案例，以及对代码内部信息，运行机制的说明文档。

&emsp;虽然说按照计划就分为这么四步，但是由于之前的 gis 还是能够使用的，而且重新开发还是很花费时间的(主要是什么代码内部的信息都没有留下，内部的运行机制都不知道，基本是从零开始学起)，所以优先级不是很高。当时也说了，如果有别的项目的话，就优先完成别的项目。所以，到我离职前，勉勉强强完成了第一步吧，其中控制器和瓦片更新虽然能够运行，但还是存在一些问题，需要优化完善。有点小遗憾吧。

&emsp;额外说一下，虽然说重新开发 gis 框架的时候，参考了不少其他的 gis 框架，但是很多我只是学习，从中找到我需要的部分，而且为了方便，只是看了最开始的几个版本(代码少，好学习)。类似 cesium 这样的知名框架，我并没有丰富的使用经验，也没有在实际的项目中进行使用，更谈不上掌握。



